<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <title>TVScreener 监控面板</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous"></script>
    <style>
        :root {
            color-scheme: light dark;
        }
        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            background: #0f172a;
            color: #e2e8f0;
        }
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem 4rem;
        }
        h1 {
            font-size: 2rem;
            margin-bottom: 1rem;
        }
        .meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .card {
            background: rgba(15, 23, 42, 0.65);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.45);
            backdrop-filter: blur(16px);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }

        .symbol-table-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .symbol-filter {
            position: relative;
            flex: 1 1 220px;
            max-width: 360px;
        }

        .symbol-filter input {
            width: 100%;
            padding: 0.6rem 0.85rem;
            border-radius: 10px;
            border: 1px solid rgba(148, 163, 184, 0.25);
            background: rgba(15, 23, 42, 0.65);
            color: #e2e8f0;
            font-size: 0.95rem;
        }

        .symbol-filter input::placeholder {
            color: #64748b;
        }

        .symbol-table-wrapper {
            max-height: 360px;
            overflow-y: auto;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.18);
        }

        .symbol-table-wrapper table {
            margin: 0;
        }

        .symbol-table-wrapper thead {
            position: sticky;
            top: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(6px);
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }
        th {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #94a3b8;
        }
        tr {
            transition: background 0.2s ease;
        }

        tr:hover {
            background: rgba(30, 41, 59, 0.6);
            cursor: pointer;
        }
        tr.active {
            background: rgba(56, 189, 248, 0.18);
        }
        tr.active:hover {
            background: rgba(56, 189, 248, 0.28);
        }

        .status {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-weight: 600;
        }
        .status.ok {
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
        }
        .status.degraded {
            background: rgba(249, 115, 22, 0.15);
            color: #fb923c;
        }
        .chart-container {
            position: relative;
            height: 360px;
        }
        .muted {
            color: #94a3b8;
        }
        .card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .pill {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.9rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.25);
            font-weight: 600;
            font-size: 0.85rem;
            color: #e2e8f0;
            background: rgba(148, 163, 184, 0.12);
            white-space: nowrap;
        }
        .pill.buy {
            background: rgba(34, 197, 94, 0.18);
            color: #4ade80;
            border-color: rgba(74, 222, 128, 0.4);
        }
        .pill.sell {
            background: rgba(248, 113, 113, 0.18);
            color: #f87171;
            border-color: rgba(248, 113, 113, 0.4);
        }
        .pill.neutral {
            background: rgba(14, 165, 233, 0.18);
            color: #38bdf8;
            border-color: rgba(56, 189, 248, 0.35);
        }
        .symbol-insights {
            display: grid;
            grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
            gap: 1.5rem;
            margin-top: 2rem;
            align-items: stretch;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .info-item {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 12px;
            padding: 0.85rem;
            min-height: 88px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .info-item span {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #94a3b8;
        }
        .info-item strong {
            margin-top: 0.5rem;
            font-size: 1.05rem;
            font-weight: 600;
            color: #e2e8f0;
            word-break: break-word;
        }
        .ratings-list {
            list-style: none;
            padding: 0;
            margin: 0.75rem 0 0;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .ratings-list li {
            background: rgba(148, 163, 184, 0.14);
            border-radius: 999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            color: #cbd5f5;
        }
        .company-description {
            margin-top: 0.5rem;
            line-height: 1.6;
        }
        @media (max-width: 1100px) {
            .symbol-insights {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .meta {
                flex-direction: column;
            }
            th, td {
                padding: 0.5rem 0.75rem;
            }
            .chart-container {
                height: 280px;
            }

        }
    </style>
</head>
<body>
    <main>
        <header>
            <h1>TVScreener 监控面板</h1>
            <p class="muted">每 {{ settings.interval_seconds // 60 }} 分钟监控前 {{ settings.range_end - settings.range_start }} 个标的的分析师评级变化。</p>
        </header>
        <section class="meta">
            <div class="card">
                <strong>状态</strong>
                <div id="statusBadge" class="status">加载中…</div>
                <p class="muted">上次轮询：<span id="lastRun">—</span></p>
            </div>
            <div class="card">
                <strong>快照</strong>
                <p class="muted">共 <span id="totalSnapshots">0</span> 条 | <span id="totalChanges">0</span> 次评级变动</p>
                <p class="muted">最新快照：<span id="latestSnapshot">—</span></p>
            </div>
        </section>

        <section class="card" style="margin-bottom:2rem;">
            <div class="symbol-table-controls">
                <h2 style="margin:0">监控中的股票</h2>
                <label class="symbol-filter" for="symbolFilterInput">
                    <span class="sr-only">筛选股票</span>
                    <input id="symbolFilterInput" type="search" placeholder="筛选股票（支持代码与评级）" autocomplete="off">
                </label>
            </div>
            <div class="symbol-table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>股票代码</th>
                            <th>最新价格</th>
                            <th>分析师评级</th>
                            <th>更新时间</th>
                        </tr>
                    </thead>
                    <tbody id="symbolsBody">
                        <tr><td colspan="4" class="muted">加载中…</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="card" style="margin-bottom:2rem;">
            <h2 style="margin-top:0">最新分析师评级变动</h2>
            <table>
                <thead>
                    <tr>
                        <th>股票代码</th>
                        <th>变更时间</th>
                        <th>原评级</th>
                        <th>新评级</th>
                        <th>变动前价格</th>
                        <th>变动后价格</th>
                    </tr>
                </thead>
                <tbody id="changesBody">
                    <tr><td colspan="6" class="muted">加载中…</td></tr>
                </tbody>
            </table>
        </section>

        <section class="symbol-insights">
            <section class="card">
                <div class="card-header">
                    <div>
                        <h2 id="symbolTitle" style="margin:0">价格与评级历史</h2>
                        <p class="muted" id="chartCaption">从上方选择股票以加载价格历史。</p>
                    </div>
                    <div id="symbolRatingBadge" class="pill" style="display:none;">评级：—</div>
                </div>
                <div class="chart-container">
                    <canvas id="historyChart"></canvas>
                </div>
                <div class="info-grid" id="symbolMetrics"></div>
            </section>
            <section class="card">
                <div class="card-header">
                    <div>
                        <h2 id="companyName" style="margin:0">公司概览</h2>
                        <p class="muted" id="symbolMeta">选择股票以查看行业与板块信息。</p>
                    </div>
                </div>
                <p class="muted company-description" id="symbolDescription">从上方选择股票以查看公司简介与关键指标。</p>
                <div class="info-grid" id="symbolAttributes"></div>
            </section>
        </section>
    </main>

    <script>
        const statusBadge = document.getElementById('statusBadge');
        const lastRunEl = document.getElementById('lastRun');
        const totalSnapshotsEl = document.getElementById('totalSnapshots');
        const totalChangesEl = document.getElementById('totalChanges');
        const latestSnapshotEl = document.getElementById('latestSnapshot');
        const symbolsBody = document.getElementById('symbolsBody');
        const symbolFilterInput = document.getElementById('symbolFilterInput');
        const changesBody = document.getElementById('changesBody');
        const chartCaption = document.getElementById('chartCaption');
        const chartCtx = document.getElementById('historyChart');
        const symbolTitle = document.getElementById('symbolTitle');
        const symbolRatingBadge = document.getElementById('symbolRatingBadge');
        const companyNameEl = document.getElementById('companyName');
        const symbolMetaEl = document.getElementById('symbolMeta');
        const symbolDescriptionEl = document.getElementById('symbolDescription');
        const symbolAttributesEl = document.getElementById('symbolAttributes');
        const symbolMetricsEl = document.getElementById('symbolMetrics');

        let historyChart = null;
        let selectedSymbol = null;
        let lastChangesCount = 0;
        let symbolsCache = [];
        let symbolFilterText = '';

        const numberFormatter = new Intl.NumberFormat('zh-CN', { maximumFractionDigits: 2 });
        const compactFormatter = new Intl.NumberFormat('zh-CN', { notation: 'compact', maximumFractionDigits: 2 });

        function formatDate(value) {
            if (!value) return '—';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) {
                return value;
            }
            return date.toLocaleString('zh-CN');
        }

        function normaliseRatingText(value) {
            if (!value && value !== 0) return null;
            const text = String(value).trim();
            return text || null;
        }

        function ratingKeyFromText(value) {
            const text = normaliseRatingText(value);
            if (!text) return null;
            return text.toUpperCase().replace(/\s+/g, '').replace(/-/g, '');
        }

        function ratingBadgeClass(value) {
            const key = ratingKeyFromText(value);
            if (!key) return '';
            if (key.includes('SELL')) return 'sell';
            if (key.includes('BUY')) return 'buy';
            return 'neutral';
        }

        function updateRatingBadge(rating) {
            if (!rating) {
                symbolRatingBadge.style.display = 'none';
                symbolRatingBadge.className = 'pill';
                symbolRatingBadge.textContent = '评级：—';
                return;
            }
            symbolRatingBadge.style.display = 'inline-flex';
            const badgeClass = ratingBadgeClass(rating);
            symbolRatingBadge.className = badgeClass ? `pill ${badgeClass}` : 'pill';
            symbolRatingBadge.textContent = `评级：${rating}`;
        }

        function formatSignedNumber(value) {
            const numeric = typeof value === 'number' ? value : Number(value);
            if (!Number.isFinite(numeric)) {
                return null;
            }
            const absValue = Math.abs(numeric);
            const formatted = numberFormatter.format(absValue);
            if (numeric > 0) return `+${formatted}`;
            if (numeric < 0) return `-${formatted}`;
            return formatted;
        }

        function formatPercentValue(value) {
            const signed = formatSignedNumber(value);
            return signed ? `${signed}%` : null;
        }

        function formatValue(value, format) {
            if (value === null || value === undefined || value === '') {
                return '—';
            }
            if (format === 'percent') {
                const percent = formatPercentValue(value);
                return percent ?? '—';
            }
            if (format === 'compact') {
                const numeric = typeof value === 'number' ? value : Number(value);
                if (Number.isFinite(numeric)) {
                    return compactFormatter.format(numeric);
                }
            }
            if (typeof value === 'number' && Number.isFinite(value)) {
                return numberFormatter.format(value);
            }
            return value;
        }

        function filterSymbols(items, text) {
            if (!Array.isArray(items)) {
                return [];
            }
            if (!text) {
                return items;
            }
            const query = text.trim().toLowerCase();
            if (!query) {
                return items;
            }
            return items.filter((item) => {
                const symbolText = String(item.symbol ?? '').toLowerCase();
                const ratingText = String(item.analyst_rating ?? '').toLowerCase();
                return symbolText.includes(query) || ratingText.includes(query);
            });
        }

        function createInfoItem(label, valueText) {
            const container = document.createElement('div');
            container.className = 'info-item';
            const labelEl = document.createElement('span');
            labelEl.textContent = label;
            const valueEl = document.createElement('strong');
            valueEl.textContent = valueText ?? '—';
            container.append(labelEl, valueEl);
            return container;
        }

        function highlightActiveRows(symbol) {
            document.querySelectorAll('[data-symbol-row="true"]').forEach((row) => {
                const rowSymbol = row.dataset.symbol;
                if (!rowSymbol) {
                    row.classList.remove('active');
                    return;
                }
                row.classList.toggle('active', Boolean(symbol) && rowSymbol === symbol);
            });
        }

        function resetSymbolView() {
            selectedSymbol = null;
            if (historyChart) {
                historyChart.destroy();
                historyChart = null;
            }
            symbolTitle.textContent = '价格与评级历史';
            chartCaption.textContent = '从上方选择股票以加载价格历史。';
            updateRatingBadge(null);
            companyNameEl.textContent = '公司概览';
            symbolMetaEl.textContent = '选择股票以查看行业与板块信息。';
            symbolDescriptionEl.textContent = '从上方选择股票以查看公司简介与关键指标。';
            symbolAttributesEl.innerHTML = '';
            symbolAttributesEl.style.display = 'block';
            const attrMessage = document.createElement('p');
            attrMessage.className = 'muted';
            attrMessage.textContent = '未选择股票。';
            symbolAttributesEl.appendChild(attrMessage);
            symbolMetricsEl.innerHTML = '';
            symbolMetricsEl.style.display = 'block';
            const metricMessage = document.createElement('p');
            metricMessage.className = 'muted';
            metricMessage.textContent = '选择股票以查看价格统计。';
            symbolMetricsEl.appendChild(metricMessage);
            highlightActiveRows(null);
        }

        function setStatus(status, lastRun) {
            statusBadge.className = `status ${status}`;
            statusBadge.textContent = status === 'ok' ? '运行中' : '异常';
            lastRunEl.textContent = formatDate(lastRun);
        }

        async function refreshStatus() {
            try {
                const response = await fetch('/healthz');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                setStatus(data.status, data.state.last_run);
                totalSnapshotsEl.textContent = data.state.total_snapshots;
                totalChangesEl.textContent = data.state.total_rating_changes;
                latestSnapshotEl.textContent = formatDate(data.latest_snapshot);
            } catch (error) {
                console.error('Failed to refresh status', error);
            }
        }

        function renderChanges(items) {
            lastChangesCount = Array.isArray(items) ? items.length : 0;
            if (!lastChangesCount) {
                changesBody.innerHTML = '<tr><td colspan="6" class="muted">暂无评级变动记录。</td></tr>';
                return;
            }
            changesBody.innerHTML = '';
            items.forEach((item) => {
                const tr = document.createElement('tr');
                tr.dataset.symbol = item.symbol;
                tr.dataset.symbolRow = 'true';
                tr.innerHTML = `
                    <td>${item.symbol}</td>
                    <td>${formatDate(item.changed_at)}</td>
                    <td>${item.old_rating ?? '—'}</td>
                    <td>${item.new_rating ?? '—'}</td>
                    <td>${item.price_before !== null && item.price_before !== undefined ? formatValue(item.price_before, 'number') : '—'}</td>
                    <td>${item.price_after !== null && item.price_after !== undefined ? formatValue(item.price_after, 'number') : '—'}</td>
                `;
                tr.addEventListener('click', () => {
                    if (selectedSymbol !== item.symbol) {
                        loadHistory(item.symbol);
                    }
                });
                changesBody.appendChild(tr);
            });
            if (!selectedSymbol && items.length) {
                loadHistory(items[0].symbol);
            } else {
                highlightActiveRows(selectedSymbol);
            }
        }

        async function refreshChanges() {
            try {
                const response = await fetch('/api/rating_changes?limit=100');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                renderChanges(data.items ?? []);
            } catch (error) {
                console.error('Failed to refresh rating changes', error);
            }
        }
        function updateSymbolsTable(autoSelect = false) {
            const hasAnySymbols = symbolsCache.length > 0;
            const hasFilter = Boolean(symbolFilterText && symbolFilterText.trim());
            const filteredItems = filterSymbols(symbolsCache, symbolFilterText);

            if (!filteredItems.length) {
                const message = hasFilter && hasAnySymbols ? '没有匹配的股票。' : '暂无监控的股票。';
                symbolsBody.innerHTML = `<tr><td colspan="4" class="muted">${message}</td></tr>`;
                if (!hasFilter || !hasAnySymbols) {
                    resetSymbolView();
                } else {
                    highlightActiveRows(null);
                }
                return;
            }

            symbolsBody.innerHTML = '';
            filteredItems.forEach((item) => {
                const tr = document.createElement('tr');
                tr.dataset.symbol = item.symbol;
                tr.dataset.symbolRow = 'true';
                tr.innerHTML = `
                    <td>${item.symbol}</td>
                    <td>${item.price !== null && item.price !== undefined ? formatValue(item.price, 'number') : '—'}</td>
                    <td>${item.analyst_rating ?? '—'}</td>
                    <td>${formatDate(item.retrieved_at)}</td>
                `;
                tr.addEventListener('click', () => {
                    if (selectedSymbol !== item.symbol) {
                        loadHistory(item.symbol);
                    }
                });
                symbolsBody.appendChild(tr);
            });
            const hasSelected = selectedSymbol
                ? filteredItems.some((item) => item.symbol === selectedSymbol)
                : false;

            if (autoSelect && filteredItems.length) {
                if (!selectedSymbol || !hasSelected) {
                    loadHistory(filteredItems[0].symbol);
                    return;
                }
            }

            highlightActiveRows(selectedSymbol);
        }

        function renderSymbols(items) {
            symbolsCache = Array.isArray(items) ? items : [];
            if (!symbolsCache.length) {
                symbolsBody.innerHTML = '<tr><td colspan="4" class="muted">暂无监控的股票。</td></tr>';
                resetSymbolView();
                return;
            }

            const shouldAutoSelect = lastChangesCount === 0;
            updateSymbolsTable(shouldAutoSelect);
        }

        if (symbolFilterInput) {
            const handleFilterChange = () => {
                symbolFilterText = symbolFilterInput.value;
                updateSymbolsTable(false);
            };

            symbolFilterInput.addEventListener('input', handleFilterChange);
            symbolFilterInput.addEventListener('search', handleFilterChange);
        }


        async function refreshSymbols() {
            try {
                const response = await fetch('/api/symbols');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                renderSymbols(data.items ?? []);
            } catch (error) {
                console.error('Failed to refresh symbols', error);
            }
        }

        function renderSymbolMetrics(metrics, profile) {
            symbolMetricsEl.innerHTML = '';
            const items = [];
            const priceMetrics = metrics?.price ?? {};
            const ratingMetrics = metrics?.ratings ?? {};
            const period = metrics?.period ?? {};

            if (priceMetrics.change !== undefined && priceMetrics.change !== null) {
                const changeText = formatSignedNumber(priceMetrics.change);
                const pctText = formatPercentValue(priceMetrics.change_pct);
                const combined = [changeText, pctText ? `(${pctText})` : null].filter(Boolean).join(' ');
                items.push(createInfoItem('价格变动', combined || '—'));
            }
            if (priceMetrics.max !== undefined) {
                items.push(createInfoItem('区间最高价', formatValue(priceMetrics.max, 'number')));
            }
            if (priceMetrics.min !== undefined) {
                items.push(createInfoItem('区间最低价', formatValue(priceMetrics.min, 'number')));
            }
            if (priceMetrics.average !== undefined) {
                items.push(createInfoItem('平均价格', formatValue(priceMetrics.average, 'number')));
            }
            if (profile?.retrieved_at) {
                items.push(createInfoItem('最近更新时间', formatDate(profile.retrieved_at)));
            }
            if (period.start || period.end) {
                items.push(createInfoItem('统计区间', `${formatDate(period.start)} → ${formatDate(period.end)}`));
            }

            const counts = ratingMetrics.counts || {};
            if (Object.keys(counts).length) {
                const ratingItem = document.createElement('div');
                ratingItem.className = 'info-item';
                const labelEl = document.createElement('span');
                labelEl.textContent = '评级分布';
                ratingItem.appendChild(labelEl);
                const listEl = document.createElement('ul');
                listEl.className = 'ratings-list';
                Object.entries(counts)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([rating, count]) => {
                        const li = document.createElement('li');
                        li.textContent = `${rating}: ${count}`;
                        listEl.appendChild(li);
                    });
                ratingItem.appendChild(listEl);
                items.push(ratingItem);
            }

            if (!items.length) {
                symbolMetricsEl.style.display = 'block';
                const empty = document.createElement('p');
                empty.className = 'muted';
                empty.textContent = '当前选择暂无价格统计数据。';
                symbolMetricsEl.appendChild(empty);
            } else {
                symbolMetricsEl.style.display = '';
                items.forEach((item) => symbolMetricsEl.appendChild(item));
            }
        }

        function renderSymbolDetails(symbol, data) {
            const profile = data?.profile;
            const metrics = data?.metrics;
            if (!profile) {
                resetSymbolView();
                return;
            }

            const attributes = Array.isArray(profile.attributes) ? profile.attributes : [];

            companyNameEl.textContent = profile.name ? `${profile.name} (${symbol})` : `${symbol}`;
            const metaParts = [profile.sector, profile.industry].filter(Boolean);
            symbolMetaEl.textContent = metaParts.length ? metaParts.join(' • ') : '—';
            symbolDescriptionEl.textContent = profile.description || '—';
            updateRatingBadge(data?.latest?.analyst_rating ?? null);

            symbolAttributesEl.innerHTML = '';
            if (attributes.length) {
                symbolAttributesEl.style.display = '';
                attributes.forEach((attribute) => {
                    const value = formatValue(attribute.value, attribute.format);
                    symbolAttributesEl.appendChild(createInfoItem(attribute.label, value));
                });
            } else {
                symbolAttributesEl.style.display = 'block';
                const empty = document.createElement('p');
                empty.className = 'muted';
                empty.textContent = '当前股票暂无更多基本面数据。';
                symbolAttributesEl.appendChild(empty);
            }

            renderSymbolMetrics(metrics, profile);
        }

        function renderHistoryChart(symbol, items, metrics) {
            if (!Array.isArray(items) || !items.length) {
                if (historyChart) {
                    historyChart.destroy();
                    historyChart = null;
                }
                symbolTitle.textContent = `${symbol} 价格与评级历史`;
                chartCaption.textContent = `尚未记录 ${symbol} 的价格历史。`;
                return;
            }

            const labels = items.map((item) => formatDate(item.retrieved_at));
            const prices = items.map((item) => (item.price !== undefined ? item.price : null));
            const ratingScores = items.map((item) => (item.rating_score !== undefined ? item.rating_score : null));
            const ratingSeries = items.map((item) => item.analyst_rating ?? null);
            const ratingLabels = Object.fromEntries(
                Object.entries(metrics?.ratings?.score_labels ?? {}).map(([key, value]) => [Number(key), value])
            );
            const period = metrics?.period ?? {};
            const startText = period.start ? formatDate(period.start) : null;
            const endText = period.end ? formatDate(period.end) : null;
            const periodText = startText && endText ? ` · ${startText} → ${endText}` : '';

            symbolTitle.textContent = `${symbol} 价格与评级历史`;
            chartCaption.textContent = `${symbol} 的价格与评级历史${periodText}`;

            if (historyChart) {
                historyChart.destroy();
            }

            historyChart = new Chart(chartCtx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: '价格',
                            data: prices,
                            tension: 0.3,
                            borderColor: '#38bdf8',
                            backgroundColor: 'rgba(56, 189, 248, 0.25)',
                            fill: true,
                            pointRadius: 0,
                            spanGaps: true,
                            yAxisID: 'y',
                        },
                        {
                            label: '分析师评级',
                            data: ratingScores,
                            tension: 0,
                            borderColor: '#f97316',
                            backgroundColor: 'rgba(249, 115, 22, 0.15)',
                            fill: false,
                            pointRadius: 3,
                            spanGaps: true,
                            stepped: true,
                            yAxisID: 'y1',
                            custom: { ratings: ratingSeries },
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' },
                        },
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.12)' },
                            title: { display: true, text: '价格', color: '#94a3b8' },
                        },
                        y1: {
                            position: 'right',
                            ticks: {
                                color: '#f8fafc',
                                stepSize: 1,
                                callback: (value) => ratingLabels[value] ?? value,
                            },
                            grid: { drawOnChartArea: false },
                            min: -0.2,
                            max: 4.2,
                            title: { display: true, text: '评级', color: '#f8fafc' },
                        },
                    },
                    plugins: {
                        legend: { labels: { color: '#e2e8f0' } },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    if (ctx.dataset.yAxisID === 'y1') {
                                        const rating = ctx.dataset.custom?.ratings?.[ctx.dataIndex];
                                        return `评级：${rating ?? 'n/a'}`;
                                    }
                                    return `价格：${formatValue(ctx.parsed.y, 'number')}`;
                                },
                            },
                        },
                    },
                },
            });
        }

        async function loadHistory(symbol) {
            chartCaption.textContent = `正在加载 ${symbol} 的数据…`;
            selectedSymbol = symbol;
            highlightActiveRows(symbol);
            try {
                const response = await fetch(`/api/symbol/${encodeURIComponent(symbol)}/history?limit=200`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                const items = data.items ?? [];
                renderHistoryChart(symbol, items, data.metrics ?? {});
                renderSymbolDetails(symbol, data);
                highlightActiveRows(symbol);
            } catch (error) {
                console.error(`Failed to load history for ${symbol}`, error);
                if (historyChart) {
                    historyChart.destroy();
                    historyChart = null;
                }
                chartCaption.textContent = `无法加载 ${symbol} 的历史数据。`;
            }
        }

        async function bootstrap() {
            resetSymbolView();
            await Promise.all([refreshStatus(), refreshChanges(), refreshSymbols()]);

            setInterval(refreshStatus, 60000);
            setInterval(refreshChanges, 120000);
            setInterval(refreshSymbols, 120000);
        }

        bootstrap();
    </script>
</body>
</html>
